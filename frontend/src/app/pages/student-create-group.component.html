<form [formGroup]="groupForm" (ngSubmit)="submitGroup()" class="space-y-7">
  <!-- ===== Activity Selection (create mode only) ===== -->
  <div *ngIf="mode === 'create'">
    <label
      class="block text-lg font-extrabold text-slate-700 uppercase tracking-wider mb-2.5"
    >
      เลือกกิจกรรม
    </label>

    <div class="relative">
      <select
        [(ngModel)]="activityId"
        [ngModelOptions]="{ standalone: true }"
        (ngModelChange)="onActivityChange()"
        class="w-full appearance-none px-5 py-4 pr-12 rounded-2xl text-lg bg-white border border-slate-300 text-slate-900 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-500/20 focus:border-orange-400 transition"
      >
        <option [ngValue]="0" disabled>-- เลือกกิจกรรม --</option>
        <option
          *ngFor="let activity of activities"
          [ngValue]="activity.activityId"
        >
          {{ activity.title }}
        </option>
      </select>

      <svg
        class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-400"
        fill="none"
        stroke="currentColor"
        stroke-width="2.5"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M19 9l-7 7-7-7"
        />
      </svg>
    </div>
  </div>

  <!-- ===== Activity Name (edit mode - read only) ===== -->
  <div *ngIf="mode === 'edit'">
    <label
      class="block text-lg font-extrabold text-slate-700 uppercase tracking-wider mb-2.5"
    >
      กิจกรรม
    </label>
    <div
      class="w-full px-5 py-4 rounded-2xl text-lg bg-slate-50 border border-slate-200 text-slate-500"
    >
      <ng-container *ngFor="let activity of activities">
        <span *ngIf="activity.activityId === activityId">{{ activity.title }}</span>
      </ng-container>
    </div>
  </div>

  <!-- ===== Group Name ===== -->
  <div>
    <label
      class="block text-lg font-extrabold text-slate-700 uppercase tracking-wider mb-2.5"
    >
      ชื่อกลุ่ม
    </label>
    <input
      type="text"
      formControlName="groupName"
      placeholder="ชื่อกลุ่ม"
      class="w-full px-5 py-4 rounded-2xl text-lg bg-white border border-slate-300 text-slate-900 placeholder:text-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-500/20 focus:border-orange-400 transition"
    />
  </div>

  <!-- ===== Description ===== -->
  <div>
    <label
      class="block text-lg font-extrabold text-slate-700 uppercase tracking-wider mb-2.5"
    >
      รายละเอียดกลุ่ม
    </label>
    <textarea
      formControlName="description"
      rows="3"
      placeholder="รายละเอียดกลุ่ม"
      class="w-full px-5 py-4 rounded-2xl text-lg bg-white border border-slate-300 text-slate-900 placeholder:text-slate-400 shadow-sm focus:outline-none focus:ring-4 focus:ring-orange-500/20 focus:border-orange-400 transition resize-none"
    ></textarea>
  </div>

  <!-- ===== Members Picker ===== -->
  <div class="rounded-3xl border border-slate-200 bg-slate-50 p-6 sm:p-7">
    <div class="flex items-start justify-between gap-4 mb-4">
      <div>
        <p class="text-xl font-black text-slate-900">เลือกสมาชิก</p>
      </div>

      <span
        class="inline-flex items-center px-4 py-1.5 rounded-full text-md font-extrabold bg-orange-100 text-orange-700"
      >
        Selected: {{ selectedMemberIds.length }}
      </span>
    </div>

    <div *ngIf="!activityId && mode === 'create'" class="text-base text-amber-600 bg-amber-50 border border-amber-200 rounded-2xl px-5 py-4">
      กรุณาเลือกกิจกรรมก่อน เพื่อแสดงรายชื่อนักศึกษาที่สามารถเลือกได้
    </div>

    <div *ngIf="activityId && availableStudents.length === 0" class="text-base text-slate-500 bg-slate-100 border border-slate-200 rounded-2xl px-5 py-4">
      ไม่มีนักศึกษาที่สามารถเลือกได้ (อาจอยู่ในกลุ่มอื่นแล้วทั้งหมด)
    </div>

    <div
      *ngIf="activityId && availableStudents.length > 0"
      class="border border-slate-200 bg-white rounded-2xl p-3.5 max-h-72 overflow-y-auto"
    >
      <div *ngFor="let student of availableStudents" class="py-1.5">
        <label
          class="flex items-center gap-4 cursor-pointer rounded-2xl px-4 py-3 hover:bg-orange-50 transition"
        >
          <input
            type="checkbox"
            [value]="student.studentId"
            [checked]="selectedMemberIds.includes(student.studentId)"
            (change)="onMemberChange($event)"
            class="h-5 w-5 rounded-md border-slate-300 text-orange-600 focus:ring-4 focus:ring-orange-500/20"
          />

          <div class="min-w-0">
            <p class="text-lg font-bold text-slate-900 truncate">
              {{ student.fullName }}
            </p>
            <p class="text-base text-slate-500">
              {{ student.studentId }} · ชั้นปี {{ student.yearLevel }}
            </p>
          </div>
        </label>
      </div>
    </div>
  </div>

  <!-- ===== Selected Members ===== -->
  <div class="rounded-3xl border border-slate-200 bg-white p-6 sm:p-7">
    <div class="flex items-center gap-3 mb-4">
      <div
        class="inline-flex items-center justify-center w-11 h-11 rounded-2xl bg-orange-100"
      >
        <svg
          class="w-6 h-6 text-orange-600"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
      </div>

      <div class="flex-1">
        <p class="text-lg font-black text-slate-900">
          สมาชิกที่เลือก ({{ selectedMemberIds.length }})
        </p>
        <p class="text-base text-slate-600">แสดงรายชื่อที่ถูกเลือกไว้</p>
      </div>
    </div>

    <div class="flex flex-wrap gap-2.5">
      <span
        *ngFor="let id of selectedMemberIds"
        class="inline-flex items-center px-4 py-2 rounded-full text-base font-extrabold bg-indigo-600 text-white"
      >
        {{ getMemberName(id) }}
      </span>

      <span
        *ngIf="selectedMemberIds.length === 0"
        class="text-base text-slate-500"
      >
        ยังไม่ได้เลือก
      </span>
    </div>
  </div>

  <!-- ===== Action Buttons ===== -->
  <div class="pt-2 flex flex-col sm:flex-row gap-4">
    <button
      type="button"
      (click)="cancelled.emit()"
      class="sm:flex-1 inline-flex items-center justify-center px-6 py-4 rounded-2xl text-lg font-black bg-white/85 border border-white/70 ring-1 ring-black/5 shadow-sm text-slate-800 hover:bg-white transition"
    >
      ยกเลิก
    </button>
    <button
      type="submit"
      [disabled]="groupForm.invalid || submitting"
      class="sm:flex-1 relative inline-flex items-center justify-center px-6 py-4 rounded-2xl text-lg font-black text-white bg-gradient-to-r from-orange-600 to-orange-500 shadow-lg hover:shadow-xl hover:brightness-[1.02] active:scale-[0.99] transition overflow-hidden group disabled:from-slate-300 disabled:to-slate-300 disabled:shadow-none disabled:cursor-not-allowed"
    >
      <span class="relative z-10">
        {{ submitting ? 'กำลังบันทึก...' : (mode === 'create' ? 'สร้างกลุ่ม' : 'อัปเดตกลุ่ม') }}
      </span>
    </button>
  </div>
</form>
